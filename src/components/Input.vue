<template>
    <div class="input container">
        <div id="left-side">
            <div id="analysis-options" class="item">
                <span class="item-title">Analysis options</span>
                <form>
                    <fieldset>
                        <legend>Cryptanalysis mode</legend>
                        <p>
                            <input v-model="mode" type="radio" id="manual" name="cryptanalysis-mode" value="manual">
                            <label for="manual">Manual (no analysis)</label>
                        </p>
                        <p>                
                            <input v-model="mode" type="radio" id="semiauto-freq" name="cryptanalysis-mode" value="semiauto-freq">
                            <label for="semiauto-freq">Semi-automatic: frequency analysis</label><br>
                        </p>
                        <p>                
                            <input v-model="mode" type="radio" id="semiauto-pattern" name="cryptanalysis-mode" value="semiauto-pattern">
                            <label for="semiauto-pattern">Semi-automatic: pattern analysis</label><br>
                        </p>
                        <p>                
                            <input v-model="mode" type="radio" id="semiauto-pattern-fast" name="cryptanalysis-mode" value="semiauto-pattern-fast">
                            <label for="semiauto-pattern-fast">Semi-automatic: pattern analysis (fast)</label>
                        </p>
                    </fieldset>
                </form>
            </div>
            <div id="language-options" class="item">
                <span class="item-title">Language options</span>
                <form>
                    <select v-model="choosedLanguage" name="language" id="language">
                        <option value="English">English</option>
                        <option value="French">French</option>
                    </select>
                </form>
                <div><strong>IC :</strong> {{ic}} <span v-show="ic != 0">({{detectedLanguage}})</span></div>                
            </div>
            <div id="alphabet-options" class="item">
                <span class="item-title">Alphabet options</span>
                <form>
                    <fieldset>
                        <legend>Alphabet</legend>
                        <p>
                            <input v-model="alphabetType" value="predefined" type="radio" id="predefined-alphabet-radio" name="alphabet">
                            <label for="predefined-alphabet-radio">Predefined alphabet</label>
                        </p>
                        <p>
                            <input v-model="alphabetType" value="custom" type="radio" id="custom-alphabet-radio" name="alphabet">
                            <label for="custom-alphabet-radio">Custom alphabet</label>
                        </p>
                        <p v-if="alphabetType == 'predefined'">
                            <select v-model="choosedAlphabet" name="predefined-alphabet" id="predfined-alphabet">
                                <option value="ABCDEFGHIJKLMNOPQRSTUVWXYZ">ABCDEFGHIJKLMNOPQRSTUVWXYZ</option>
                                <option value="ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789">ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789</option>
                            </select>
                        </p>
                        <p v-else-if="alphabetType == 'custom'">
                            <input v-model="choosedAlphabet" type="text" name="custom-alphabet" id="custom-alphabet">
                        </p>
                    </fieldset>
                    <fieldset>
                        <input v-model="ignoreCase" type="checkbox" name="ignore-case" id="ignore-case">
                        <label for="ignore-case">Ignore case</label>
                    </fieldset>
                </form>
            </div>
            <!-- <div id="informations" class="item">
                <span class="item-title">Informations</span>
                <ul>
                    <li>
                        <strong>IC :</strong> 0.076 (French)
                        <a href="https://www.dcode.fr/index-coincidence" class="tooltip preline" data-balloon=" Index of Coincidence is a cryptanalysis technique studying the probability of finding repeating letters in an encrypted text.
                                    English : 0.0667
                                    French : 0.0778" data-balloon-length="xlarge" data-balloon-pos="right">?</a>
                    </li>
                </ul>
            </div> -->
            <div id="debug" class="item">
                <span class="item-title">Debug</span>
                <ul>
                    <li>mode: {{mode}}</li>
                    <li>choosedLanguage: {{choosedLanguage}}</li>
                    <li>choosedAlphabet: {{choosedAlphabet}}</li>
                    <li>ignoreCase: {{ignoreCase}}</li>
                </ul>
            </div>
        </div>
        <div id="right-side">
            <div id="header" class="item">
                <span class="title">Monoalphabetic Substitution</span>
                <span class="description">Lorem ipsum dolor sit amet consectetur adipisicing elit. Ipsa illo delectus dolorum mollitia rem atque consequuntur, porro aliquam officiis suscipit, omnis repellendus veniam accusamus optio consequatur eaque possimus nobis perspiciatis.</span>
            </div>
            <div id="cipher" class="item">
                <span class="item-title">Cipher</span>
                <form @submit="decode">
                    <span class="title">Paste your cipher</span>
                    <textarea v-model="text" name="cipher-text" id="cipher-text" placeholder="Paste your cipher here"></textarea>
                    <hr>
                    <span class="title">Or import your cipher as a file</span>
                    <input type="file" name="cipher-file" id="cipher-file">
                    <hr>
                    <input type="submit" value="Decrypt">
                </form>
            </div>
        </div>
    </div>
</template>

<script>
import analyse from '../analyse.js'

export default {
    name: 'Input',
    data() {
        return {
            mode: 'manual',
            choosedLanguage: 'English',
            alphabetType: 'predefined',
            choosedAlphabet: 'ABCDEFGHIJKLMNOPQRSTUVWXYZ',
            ignoreCase: true,
            text: ""
        }
    },
    computed: {
        ic() {
            if(this.text == "" || this.text.length <= 10) return 0.0

            const text = this.text.toLowerCase()
            const letters = {}
            let lettersCount = 0
            for(const l of text) {
                if(!letters[l]) {
                    letters[l] = 1
                } else {
                    letters[l] += 1
                }
                lettersCount += 1
            }
            
            const denom = lettersCount * (lettersCount - 1)

            let ret = 0.0
            for(const v of Object.values(letters)) {
                ret += (v * (v - 1)) / denom
            }
            return Math.round(ret * 1000) / 1000
        },
        detectedLanguage() {
            if(this.ic < 0.05) return 'Polyalphabetic'

            const ics = {
                "English": 0.0667,
                "French": 0.0778,
                // "Allemand": 0,0762,
                // "Espagnol": 0,0770,
            }
            let best = "English"
            let score = Math.abs(ics[best] - this.ic)
            for(let key in ics) {
                let currentScore = Math.abs(ics[key] - this.ic)
                if(currentScore < score) {
                    best = key
                    score = currentScore
                }
            }
            //Change selected language
            // this.choosedLanguage = best            
            return best
        },
    },
    methods: {
        decode(e) {
            e.preventDefault()
            console.log('Decode start')

            //Compuet text
            let text = this.text
            if(this.ignoreCase) {
                text = text.toUpperCase()
            }

            // Compute substitution
            const sub = {}
            for(let k of this.choosedAlphabet) {
                sub[k] = k
            }

            //Algos
            const sub2 = analyse.frequenceAnalysis(analyse.FRENCH_FREQS, text, sub)
            console.log(sub2);
            

            this.$emit('decode', {text, sub: sub2})
        }
    },
    components: {
    }
}
</script>

<style scoped>
#header .title{
    display: block;
    margin: 0 0 15px;
    /* font-family: 'Abril Fatface', cursive; */
    font-family: 'Dancing Script';
    text-align: center;
    color: #caba49;
    font-size: 26px;    
    /* letter-spacing: 1px; */
}
#header .description{
    display: block;
    color: #605716;
    font-size: 15px;
    line-height: 20px;
    padding-bottom: 10px;
}

form p{
    margin: 0;
}
form label{
    color: #a29429;
    font-size: 13px;
    position: relative;
    bottom: 3px;
}
fieldset{
    padding-top: 10px;
    padding-bottom: 10px;
    margin: 2px 0;
    border: 1px solid #f9f5dd;
}
fieldset legend{
    color: #605716;
    padding: 0 10px;
}

#cipher textarea{
    box-sizing: border-box;
    min-width: 100%;
    height: 250px;
    padding: 10px 12px;
    line-height: 16px;
    color: #605716;
    border: 1px solid #efe9cb;
}
select, input[type="text"], input[type="file"]{
    box-sizing: border-box;
    width: 100%;
    margin: 4px 0;
}

input[type="submit"]{
    display: block;
    width: 100%;
    margin: 0 auto;
    padding: 5px 10px;
    cursor: pointer;
    color: #c6ba61;
    border: 1px solid #efe9cb;
    background-color: #fff;
    /* background-color: #ece4bc; */
}
input[type="submit"]:hover{
    color: #fff;
    background-color: #ece4bc;
}
input[type="file"]{
    color: #aaa479;
}

hr{
    border: 0;
    border-bottom: 1px solid #f9f5dd;
}
form .title{
    display: block;
    color: #caba49;
    margin: 2px 0 5px;
}
form .title::before{
    content: '# ';
}
</style>
